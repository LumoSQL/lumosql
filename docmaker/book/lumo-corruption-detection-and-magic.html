<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Corruption Detection</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="1.1-front-page.html"><strong aria-hidden="true">1.</strong> Welcome</a></li><li class="chapter-item expanded "><a href="about.html"><strong aria-hidden="true">2.</strong> About LumoSQL</a></li><li class="chapter-item expanded "><a href="1.2-top-features.html"><strong aria-hidden="true">3.</strong> Top Features</a></li><li class="chapter-item expanded "><a href="1.4-install-LumoSQL.html"><strong aria-hidden="true">4.</strong> Install</a></li><li class="chapter-item expanded "><a href="quickstart.html"><strong aria-hidden="true">5.</strong> Quick Build and Benchmark</a></li><li class="chapter-item expanded affix "><li class="part-title">Features</li><li class="chapter-item expanded "><a href="3.4-not-forking-tool.html"><strong aria-hidden="true">6.</strong> Not-Forking Tool</a></li><li class="chapter-item expanded "><a href="lumo-build-benchmark.html"><strong aria-hidden="true">7.</strong> Build and Benchmark System (build.tcl)</a></li><li class="chapter-item expanded "><a href="backends.html"><strong aria-hidden="true">8.</strong> Available Backends - SQLite B-tree and LMDB</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lumo-sqlite-bdb-backend.html"><strong aria-hidden="true">8.1.</strong> BDB 18.1.32 Backend</a></li><li class="chapter-item expanded "><a href="lumo-malbrain-backend.html"><strong aria-hidden="true">8.2.</strong> Karl Malbrain's C Btree</a></li></ol></li><li class="chapter-item expanded "><a href="lumo-corruption-detection-and-magic.html" class="active"><strong aria-hidden="true">9.</strong> Corruption Detection</a></li><li class="chapter-item expanded "><a href="3.3-benchmarking.html"><strong aria-hidden="true">10.</strong> Benchmarking</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lumo-benchmark-filter.html"><strong aria-hidden="true">10.1.</strong> Displaying Benchmark Results (benchmark-filter.tcl)</a></li><li class="chapter-item expanded "><a href="statistical_analysis.html"><strong aria-hidden="true">10.2.</strong> Statistical Analysis</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">New features</li><li class="chapter-item expanded "><a href="rbac-design.html"><strong aria-hidden="true">11.</strong> Design of Role-Based Access Control</a></li><li class="chapter-item expanded "><a href="encryption.html"><strong aria-hidden="true">12.</strong> Encryption</a></li><li class="chapter-item expanded "><a href="lumion_intro.html"><strong aria-hidden="true">13.</strong> Lumion</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rfc.html"><strong aria-hidden="true">13.1.</strong> Lumion RFC</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Research</li><li class="chapter-item expanded "><a href="2.1-development-landscape.html"><strong aria-hidden="true">14.</strong> SQLite Development Landscape</a></li><li class="chapter-item expanded "><a href="3.7-relevant-codebases.html"><strong aria-hidden="true">15.</strong> Overview of Relevant Codebases</a></li><li class="chapter-item expanded "><a href="2.4-relevant-knowledgebase.html"><strong aria-hidden="true">16.</strong> Overview of the Relevant Knowledgebase</a></li><li class="chapter-item expanded "><a href="3.6-development-notes.html"><strong aria-hidden="true">17.</strong> LumoSQL 2019 Prototype</a></li><li class="chapter-item expanded affix "><li class="part-title">Design</li><li class="chapter-item expanded "><a href="api.html"><strong aria-hidden="true">18.</strong> SQLite API Interception Points</a></li><li class="chapter-item expanded "><a href="virtual-machine.html"><strong aria-hidden="true">19.</strong> SQLite Virtual Machine Layer</a></li><li class="chapter-item expanded "><a href="WALs.html"><strong aria-hidden="true">20.</strong> LMDB Alternative to WALs</a></li><li class="chapter-item expanded "><a href="what-are-savepoints.html"><strong aria-hidden="true">21.</strong> Savepoints in SQLite</a></li><li class="chapter-item expanded "><a href="online-database-servers.html"><strong aria-hidden="true">22.</strong> Online Database Servers</a></li><li class="chapter-item expanded affix "><li class="part-title">Other</li><li class="chapter-item expanded "><a href="LumoSQL-PhaseII-Announce.html"><strong aria-hidden="true">23.</strong> News - Phase II Announcement</a></li><li class="chapter-item expanded "><a href="release-announce-0.4.html"><strong aria-hidden="true">24.</strong> News - Release 0.4 Announcement</a></li><li class="chapter-item expanded "><a href="release-announce-0.3.html"><strong aria-hidden="true">25.</strong> News - Release 0.3 Announcement</a></li><li class="chapter-item expanded "><a href="lumo-gsoc-ideas.html"><strong aria-hidden="true">26.</strong> Google Summer of Code 2021</a></li><li class="chapter-item expanded "><a href="lumo-proposed-debug.html"><strong aria-hidden="true">27.</strong> SQLite Debug Proposal</a></li><li class="chapter-item expanded "><a href="CONTRIBUTING.html"><strong aria-hidden="true">28.</strong> Conributing</a></li><li class="chapter-item expanded "><a href="lumosql-meetbot.html"><strong aria-hidden="true">29.</strong> Contributing - IRC Meetbot</a></li><li class="chapter-item expanded "><a href="CODE-OF-CONDUCT.html"><strong aria-hidden="true">30.</strong> Code of Conduct</a></li><li class="chapter-item expanded "><a href="3.2-legal-aspects.html"><strong aria-hidden="true">31.</strong> Legal Aspects</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="licensing.html"><strong aria-hidden="true">31.1.</strong> Licensing</a></li><li class="chapter-item expanded "><a href="MIT.html"><strong aria-hidden="true">31.2.</strong> MIT Licence</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- SPDX-License-Identifier: CC-BY-SA-4.0 -->
<!-- SPDX-FileCopyrightText: 2020 The LumoSQL Authors -->
<!-- SPDX-ArtifactOfProjectName: LumoSQL -->
<!-- SPDX-FileType: Documentation -->
<!-- SPDX-FileComment: Original by Dan Shearer, 2020 -->
<h1 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h1>
<ul>
<li><a href="#summary-of-sql-database-corruption-detection">Summary of SQL Database Corruption Detection</a></li>
<li><a href="#sqlite-and-integrity-checking">SQLite and Integrity Checking</a></li>
<li><a href="#lumosql-checksums-and-the-sqlite-on-disk-file-format">LumoSQL Checksums and the SQLite On-disk File Format</a></li>
<li><a href="#design-of-the-sqlite-checksum-vfs-loadable-extension">Design of the SQLite Checksum VFS Loadable Extension</a></li>
<li><a href="#goals-for-corruption-detection">Goals for Corruption Detection</a></li>
<li><a href="#design-for-corruption-detection">Design for Corruption Detection</a>
<ul>
<li><a href="#for-non-row-data">For Non-row Data</a></li>
<li><a href="#for-row-data">For Row Data</a></li>
</ul>
</li>
<li><a href="#implementation-for-corruption-detection">Implementation for Corruption Detection</a></li>
</ul>
<p><img src="./images/lumo-corruption-detection-and-magic-intro.png" alt="" title="Not Yet Done" /></p>
<h1 id="summary-of-sql-database-corruption-detection"><a class="header" href="#summary-of-sql-database-corruption-detection">Summary of SQL Database Corruption Detection</a></h1>
<p>One of the short-term goals stated in the <a href="./lumo-project-aims.html">LumoSQL Project Aims</a> is:</p>
<blockquote>
<p>LumoSQL will improve SQLite quality and privacy compliance by introducing
optional on-disk checksums for storage backends including to the original
SQLite btree format. This will give real-time row-level corruption detection.</p>
</blockquote>
<p>This design and implementation discussion focusses on row-level corruption 
detection, which also gives the user a very rapid way of detecting changes.
The change detection aspect of row-level corruption detection is not dealt
with here, except that it is possible the speed benefits for detecting changes
might in many cases outweigh the costs of maintaining the checksum row.</p>
<p>It seems quite extraordinary that in 2020 none of the major online databases -
not Posgresql, Oracle, MariaDB, SQLServer or others - have the built-in ability
to check during a SELECT operation that the row being read from disk is exactly
the row that was previously written. There are many reasons why data can get
modified, deleted or overwritten outwith the control of the database, and the
ideal way to respond to this is to notify the database when a corrupt row is
accessed.  All that is needed is for a hash of the row to be stored with the
row when it is written.</p>
<p>All the major online databases have the capacity for an external process to
check disk files for database corruption, as does SQLite. This is very
different from real-time integrity checking, and cannot be done in real time.</p>
<p>Knowing that a corruption problem is limited to a row or an itemised
list of rows reduces a general &quot;database corruption problem&quot; down to a bounded
reconstruction task. Users can have confidence in the remainder of a database
even if there is corruption found in some rows.</p>
<p>This problem has been recognised and solved inefficiently at the SQL level by
various projects. Two of these are <a href="https://www.periscopedata.com/blog/hashing-tables-to-ensure-consistency-in-postgres-redshift-and-mysql">Periscope Data's Per-table Multi-database Solution</a>
and <a href="https://www.percona.com/blog/2018/10/12/track-postgresql-row-changes-using-public-private-key-signing/">Percona's Postgresql Public Key Row Tracking</a>.
By using SQL code rather than modifying the database internals there is a
performance hit. Both these companies specialise in performance optimisation
but choose not to apply it to this feature, suggesting they are not convinced
of high demand from users.</p>
<p>Interestingly, all the big online databases have row-level security, which has
many similarities to the problem of corruption detection. </p>
<p>For those databases that offer encryption, this is effectively page-level or
column-based hashes and therefore there is corruption detection by implication.
However this is not row-based checksumming, and it is not on by default in any
of the most common databases.</p>
<p>It is possible to introduce a checksum on database pages more easily than for
every row, and transparently to database users. However, knowing a database
page is corrupt isn't much help to the user, because there could be many rows
in a single page.</p>
<p>More on checksumming for SQL databses can be found referenced in <a href="./2.4-relevant-knowledebase/#list-of-relevant-sql-checksumming-related-knowledge">SQLite Relevant Knowledgebase</a>) </p>
<h1 id="sqlite-and-integrity-checking"><a class="header" href="#sqlite-and-integrity-checking">SQLite and Integrity Checking</a></h1>
<p>The SQLite developers go to great lengths to avoid database corruption, within
their project goals. Nevertheless, corrupted SQLite databases are an everyday
occurance for which there are recovery procedures and commercial tools.</p>
<p>SQLite does have checksums already in some places:</p>
<ul>
<li>for the journal transaction log (superceded by the Write Ahead Log system)</li>
<li>for each database page when using the closed-source SQLite Encryption Extension</li>
<li>for each page in a WAL file</li>
<li>for each page when using the Checksum VFS Extension, discussed below</li>
</ul>
<p>SQLite also has <a href="https://www.sqlite.org/pragma.html#pragma_integrity_check">PRAGMA integrity_check</a> and
<a href="https://www.sqlite.org/pragma.html#pragma_quick_check">PRAGMA quick_check</a>
which do partial checking, and which do not require exclusive access to the
database. These checks have to scan the database file sequentially and verify
the logic of its structure, because there are no checksums available to make it
work more quickly.</p>
<p>None of these are even close to end user benefits of row-level corruption
detection, at the potential cost of speed.</p>
<p>SQLite does have a file change counter in its database header, in 
<a href="https://www.sqlite.org/fileformat.html">offset 24 of the official file format</a>, however this
is not itself subject to integrity checks nor does it contain information about the rest of the file,
so it is a hint rather than a guarantee.</p>
<p>SQLite applications often need row-level integrity checking even more than the online databases because:</p>
<ul>
<li>SQLite embedded and IoT use cases often involve frequent power loss, which is the most likely time for corruption to occur.</li>
<li>an SQLite database is an ordinary filesystem disk file stored wherever the user decided, which can often be deleted or overwritten by any unprivileged process.</li>
<li>it is easy to backup an SQLite database partway through a transaction, meaning that the restore will be corrupted</li>
<li>SQLite does not have robust locking mechanisms available for access by multiple processes at once, since it relies on lockfiles and Posix advisory locking </li>
<li>SQLite provides the <a href="https://www.sqlite.org/vfs.html">VFS API Interface</a> which users can easily misuse to ignore locking via the sql3_*v2 APIs</li>
<li>the on-disk file format is seemingly often corrupted regardless of use case. Better evidence on this is needed but authors of SQLite data file recovery software (see listing in <a href="./2.4-relevant-knowledebase/#list-of-relevant-sql-checksumming-related-knowledge">SQLite Relevant Knowledgebase</a>) indicates high demand for their services. Informal shows of hands at conferences indicates that SQLite users expect corruption.</li>
</ul>
<p>sqlite.org has a much more detailed, but still incomplete, summary of <a href="https://www.sqlite.org/howtocorrupt.html">How to Corrupt an SQLite Database</a>.</p>
<h1 id="lumosql-checksums-and-the-sqlite-on-disk-file-format"><a class="header" href="#lumosql-checksums-and-the-sqlite-on-disk-file-format">LumoSQL Checksums and the SQLite On-disk File Format</a></h1>
<p>The SQLite database format is widely used as a defacto standard. LumoSQL ships
with the lumo-backend-mdb-traditional which is the unmodified SQLite on-disk
format, the same code generating the same data. There is no corruption
detection included in the file format for this backend.  However corruption
detection is available for the traditional backend, and other backends that do
not have scope for checksums in their headers. For all of these backends,
LumoSQL offers a separate metadata file containing integrity information.</p>
<p>The new backend lumo-backend-mdb-updated adds row-level checksums in the header
but is otherwise identical to the traditional SQLite MDB format. </p>
<p>There is an argument that any change at all is the same as having a completely
different format.  This is not a strong argument against adding checksums to
the traditional SQLite on-disk format because with encryption increasingly
becoming mandatory, the standard cannot apply. The sqlite.org closed-source SSE
solution is described as &quot;All database content, including the metadata, is
encrypted so that to an outside observer the database appears to be white
noise.&quot; Other solutions are possible involving metadata that is not encrypted
(but definitely checksummed), but in any case, there is no on-disk standard for
SQLite databases with encryption.</p>
<h1 id="design-of-the-sqlite-checksum-vfs-loadable-extension"><a class="header" href="#design-of-the-sqlite-checksum-vfs-loadable-extension">Design of the SQLite Checksum VFS Loadable Extension</a></h1>
<p>In April 2020 the <a href="https://sqlite.org/cksumvfs.html">SQLite Checksum VFS</a> was 
committed to the <a href="https://sqlite.org/src/file/ext/misc/cksumvfs.c">ext/ source tree</a>.
The design goals were:</p>
<blockquote>
<p>The checksum VFS extension is a VFS shim that adds an 8-byte checksum to the
end of every page in an SQLite database. The checksum is added as each page
is written and verified as each page is read. The checksum is intended to
help detect database corruption caused by random bit-flips in the mass
storage device. </p>
</blockquote>
<p>It is important to note that this VFS is among the very first, if not the first,
of mainstream databases to recognise that all read operations should be subject to
validation.</p>
<p>The VFS overloads the low-level Read() function like this:</p>
<pre><code>/* Verify the checksum if
 **    (1) the size indicates that we are dealing with a complete
 **        database page
 **    (2) checksum verification is enabled
 **    (3) we are not in the middle of checkpoint
*/
</code></pre>
<p>This means that if a page-level corruption is detected during a read operation
then SQLITE_IOERR_DATA is returned. This implementation has some major problems, including:</p>
<ul>
<li>No information about the logical location of this error, eg what row(s) it
affects. The application knows nothing about how rows map to pages.</li>
<li>No facility for isolation or recovery of data</li>
<li>Brittle implementation due to requirements of the file format. The
&quot;bytes of reserved space on each page&quot;
value at offset 20 the SQLite database header must be exactly 8.</li>
</ul>
<p>Good points to learn from this VFS include:</p>
<ul>
<li>the various PRAGMAs implememnted for control and ad hoc verification</li>
<li>the new data error</li>
<li>the fact that the status of verification is made visible via a SELECT</li>
<li>page level detection protects all parts of the database, not just rows</li>
</ul>
<h1 id="goals-for-corruption-detection"><a class="header" href="#goals-for-corruption-detection">Goals for Corruption Detection</a></h1>
<ul>
<li>Similar control interface to the Checksum VFS</li>
<li>Row-oriented detection</li>
<li>Detection available from SQL, with recovery an option</li>
<li>Special column, just like RowID</li>
<li>Complete abort also an option</li>
<li>Optionally include page level as well, however, not necessarily</li>
</ul>
<h1 id="design-for-corruption-detection"><a class="header" href="#design-for-corruption-detection">Design for Corruption Detection</a></h1>
<p>Row-level checksum data will be stored as an extra column. Non-row data will
be stored according to the same mechanism needed for encryption and other 
LumoSQL features. Per-row checksums are a valid choice without checksums 
for the other data including indexes and metadata.</p>
<p>It isn't yet clear whether there is merit in adding table-level corruption
detection, given that page-level checksumming is possible for all the 
initally-expected btree-type backends for SQLite. This can be added at a 
later stage, and would be included in the category of non-row data.</p>
<h2 id="for-non-row-data"><a class="header" href="#for-non-row-data">For Non-row Data</a></h2>
<p>Non-row data means all metadata associated with a LumoSQL database, which may
be considerably more than is with a traditional SQLite database depending on
the encryption or other options that are selected. We already know from the
Checksum VFS implementation that there is very little scope for adding checksum
metadata to a traditional SQLite file. </p>
<p>All LumoSQL backends can have corruption detection enabled, with the metadata
stored either directly in the backend database files, or in a separate file.
When a user switches on checksums for a database, metadata needs to be stored.</p>
<p>This depends on two new functions needed in any case for labelling LumoSQL
databases provided by backend-magic.c: lumosql_set_magic() and
lumosql_get_magic(). These functions add and read a unique metadata signature
to a LumoSQL database.</p>
<ol>
<li>
<p>if possible magic is inserted into the existing header</p>
</li>
<li>
<p>if not a separate &quot;metadata&quot; b-tree is created which contains a key &quot;magic&quot;
and the appropriate value. get_magic() will look for the special metadata
b-tree and the &quot;magic&quot; key</p>
</li>
</ol>
<h2 id="for-row-data"><a class="header" href="#for-row-data">For Row Data</a></h2>
<p>High-level design for row-level checksums is:</p>
<ol>
<li>an internally maintained row hash updated with every change to a row</li>
<li>If a corruption is detected on read, LumoSQL should make maximum relevant
fuss. At minimum, <a href="https://www.sqlite.org/rescode.html#corrupt">error code 11 is SQLITE_CORRUPT</a> but there is also
SQLITE_IOERR_DATA (not SQLITE_IOERR_DATA is missing from the official SQLite 
list of error codes, but this seems to be an error.)</li>
<li>This hash is kept in a special column so that user-level logic can do not
only corruption detection, but also change detection.</li>
</ol>
<p>At a later stage a column checksum can be added giving change detection on a
table, or corruption detection for read-only tables.</p>
<p>In the case where there is a separate metadata file, a function pair in
lumo-backend-magic.c reads and writes a whole-of-file checksum for the
database. This can't be done for where metadata is stored in the main database
file because it is a recursive problem. This is like a fail-early case of 
all other corruption detection, perhaps to warn the application to run 
integrity checks.</p>
<h1 id="implementation-for-corruption-detection"><a class="header" href="#implementation-for-corruption-detection">Implementation for Corruption Detection</a></h1>
<p>There is already precedent for having a column with metadata for every row, as 
explained in <a href="https://sqlite.org/c3ref/last_insert_rowid.html">the Last Insert Rowid documentation</a>:</p>
<blockquote>
<p>Each entry in most SQLite tables (except for WITHOUT ROWID tables) has a unique
64-bit signed integer key called the &quot;rowid&quot;. The rowid is always available as
an undeclared column named ROWID, OID, or <em>ROWID</em> as long as those names are
not also used by explicitly declared columns.</p>
</blockquote>
<p>The implementation for corruption detection is to perform similar operations to
maintain a similar implicit column. In every non-index btree, the 
btree.c/sqlite3BtreeInsert() is called before every write of a row. At this point
the full row data is known, and so (just before invalidateIncrblobCursors() is
called in that function) we can add a hash of that data to the ROWCSUM column.</p>
<p>For reading, the function sqlite3_step() sees every row read from a table, and 
can check that the hash matches the data about to be returned to the user.</p>
<p>The user can execute:</p>
<pre><code>    SELECT ROWCSUM from table;
</code></pre>
<p>and treat the results like any other column return (which is how change detection can 
be managed, by storing the checksum results in another column.)</p>
<p><a href="https://sqlite.org/withoutrowid.html">WITHOUT ROWID</a> tables are intended for
corner cases requiring marginally greater speed. Without some specific addition
reason not thought of yet, it seems incorrect to add checksums to a WITHOUT
ROWID table because that will reduce the one advantage they provide.</p>
<p>main.c/sqlite3_table_column_metadata() will need to know about ROWCSUM (and
<em>ROWCSUM</em>), however this does not seem to be vital functionality, used only in
shell.c and as a feature for extensions to export. </p>
<p>The control mechanism will be the same as for the Checksum VFS Extension, 
with the addition of the term &quot;<em>row</em>&quot; to make it clear this is on a per-row
rather than per-page basis:</p>
<pre><code>PRAGMA checksum_row_verification;          -- query status
PRAGMA checksum_row_verification=OFF;      -- disable verification
PRAGMA checksum_row_verification=ON;       -- re-enable verification

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="lumo-malbrain-backend.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="3.3-benchmarking.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="lumo-malbrain-backend.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="3.3-benchmarking.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
