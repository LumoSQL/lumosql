# LumoSQL Documentation Makefile
#
# This Makefile will do a test rendering of Github flavoured Markdown to HTML
# 
# Copyright 2021 The LumoSQL Authors under the terms contained in the file LICENSES/MIT
#
# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2021 The LumoSQL Authors
# SPDX-ArtifactOfProjectName: LumoSQL -->
# SPDX-FileType: Code -->
# SPDX-FileComment: Original by Dan Shearer, 2019 -->
#
#
#
# In order to use this Makefile, you need Pandoc version 2.0 or higher, https://pandoc.org
#
# This Makefile does not do many safety checks yet

# Directory containing source (Markdown) files
source := $(CURDIR)/doc

# Temporary target directory for HTML
output := /tmp/lumo-www

# All markdown files in src/ are considered sources
sources := $(wildcard $(source)/*.md)

# Convert the list of source files (Markdown files in directory src/)
# into a list of output files (HTML files in temporary directory)
objects := $(patsubst %.md,%.html,$(subst $(source),$(output),$(sources)))

# Default target (ie the first target) prints help
default: help

## webcheck: Generate local copy of html files from Markdown
webcheck: preptmp $(objects)

# Recipe for getting clean temporary directory for local HTML rendering of GHF Markdown
# Never mind race condition
preptmp: checkclean
	echo $(output)
	mkdir $(output)
	cp -a images $(output)


# Recipe for converting a Markdown file into PDF using Pandoc
$(output)/%.html: $(source)/%.md
	pandoc \
		--lua-filter=bin/md-links-html.lua \
		-f gfm  $< \
		-o $@

# Recipe for cleaning files from webcheck
checkclean:
	if test -d $(output); then \
	    rm -f $(output)/*.html; \
	    rm -f $(output)/images/*; \
	    rm -df $(output)/images; \
	    rm -df $(output); \
	fi

pubdir := /tmp/lumo-pubwww
lumoweb := lumosql.github.io
l := $(pubdir)/$(lumoweb)
website-files := *.md images/* 

## webpublish: Regenerate website using git commands (avoiding Github-only techniques)
webpublish: pubclean
	# stop if there are differences with the github wwww tree, whether committed or not
	cd $(source) ; if !(git update-index --refresh); then echo "STOPPING: Uncommitted files in $(source)"; false; fi
	mkdir $(pubdir)
	git clone https://github.com/LumoSQL/$(lumoweb) $(l)
	# backup the gh Pages config file because it may have been set from the gh web interface
	cp $(l)/_config.yml $(pubdir)
	cd $(l) ; rm -rf *
	cp -av $(website-files) $(l)
	cp $(pubdir)/_config.yml $(l)
	# delete files that were copied from the local web repo but have been deleted from master
	cd $(l) ; git diff --name-only --diff-filter=D -z | xargs -0 git rm --cached
	echo "This website automatically generated on $(shell date) by https://github.com/LumoSQL/doc/www/Makefile" > $(l)/README
	git commit --dry-run -a --no-edit --author LumoSQL Autogenerated <autogen@example.org>
	git push --dry-run

pubclean:
	if test -d $(pubdir); then \
		rm -rf $(pubdir) ; \
	fi
   

.PHONY : clean

## clean: Delete all files that could have been made by this Makefile
clean: checkclean pubclean

## help: prints this auto-generated help from comment lines starting with '##'
help:	Makefile
	@echo 
	@echo  "LumoSQL Documentation Makefile"
	@echo 
	@sed -n 's/^##//p' $<
	@echo 
